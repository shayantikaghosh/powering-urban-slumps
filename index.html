<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urban Synergy Hub Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        canvas {
            background-color: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 100%;
            height: auto;
            display: block;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-green-50 to-blue-100 p-4 sm:p-8 text-gray-800 flex items-center justify-center">
    <div class="bg-white rounded-3xl shadow-2xl p-6 sm:p-10 w-full max-w-4xl border border-gray-200">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-blue-800 mb-8 leading-tight">
            <span class="block">Urban Synergy Hub</span>
            <span class="block text-xl sm:text-2xl text-green-600 mt-2">Hybrid Energy System Simulator</span>
        </h1>

        <!-- Input Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="flex flex-col">
                <label for="dailyWasteKg" class="text-lg font-semibold text-gray-700 mb-2">
                    Daily Waste Generated (kg)
                </label>
                <input
                    type="number"
                    id="dailyWasteKg"
                    value="5000"
                    min="0"
                    class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                />
                <p class="text-sm text-gray-500 mt-1">Total solid waste from the community.</p>
            </div>
            <div class="flex flex-col">
                <label for="rooftopAreaSqM" class="text-lg font-semibold text-gray-700 mb-2">
                    Rooftop Area for Solar (sq M)
                </label>
                <input
                    type="number"
                    id="rooftopAreaSqM"
                    value="500"
                    min="0"
                    class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                />
                <p class="text-sm text-gray-500 mt-1">Available space for solar panel installation.</p>
            </div>
            <div class="flex flex-col">
                <label for="numHouseholds" class="text-lg font-semibold text-gray-700 mb-2">
                    Number of Households
                </label>
                <input
                    type="number"
                    id="numHouseholds"
                    value="1000"
                    min="0"
                    class="p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                />
                <p class="text-sm text-gray-500 mt-1">Households to be served by the system.</p>
            </div>
        </div>

        <!-- Conceptual System Layout Section -->
        <h2 class="text-2xl sm:text-3xl font-bold text-center text-blue-700 mb-6">Conceptual System Layout (Block Diagram)</h2>
        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner mb-10 border border-gray-200">
            <p class="text-lg text-gray-700 mb-4">
                This diagram provides a high-level overview of the main components and energy flow within the Urban Synergy Hub.
            </p>
            <div class="flex flex-col items-center space-y-4 text-center text-sm font-mono">
                <pre class="bg-white p-4 rounded-lg shadow-md border border-gray-300 text-left overflow-x-auto">
{`
+-------------------+      +---------------------+
| WASTE COLLECTION  | -->  | ANAEROBIC DIGESTER  |
| (Organic Waste)   |      | (Waste-to-Energy)   |
+---------+---------+      +----------+----------+
          |                         |
          | (Biogas)                | (Bio-fertilizer)
          v                         v
+---------+---------+      +---------------------+
| BIOGAS GENERATOR  |      | AGRICULTURAL USE    |
| (Electricity)     |      +---------------------+
+---------+---------+
          | (AC Power)
          v
+-------------------+      +---------------------+
| ROOFTOP SOLAR PV  | -->  | INVERTER /          |
| (DC Power)        |      | CHARGE CONTROLLER   |
+-------------------+      +----------+----------+
                                     | (DC/AC Conversion)
                                     v
+-------------------+      +---------------------+
| BATTERY STORAGE   |<--->| POWER MANAGEMENT    |
| (Energy Buffer)   |      | UNIT (PMU)          |
+-------------------+      +----------+----------+
                                     |
                                     v
+------------------------------------------------+
|       LOCAL MICRO-GRID DISTRIBUTION            |
| (Smart Meters, Circuit Breakers, Wiring)       |
+------------------------------------------------+
          |
          v
+-------------------+      +---------------------+
| COMMUNITY LOADS   |      | STREET LIGHTING     |
| (Homes, Shops)    |      | (Public Areas)      |
+-------------------+      +---------------------+
`}
                </pre>
                <p class="text-xs text-gray-500 mt-3">
                    *(This block diagram outlines the functional flow. For detailed electrical connections and physical layout, OrCAD would be used.)*
                </p>
            </div>
        </div>

        <!-- Electrical Component Levelling Diagram (Conceptual Description) -->
        <h2 class="text-2xl sm:text-3xl font-bold text-center text-blue-700 mb-6">Electrical Component Levelling Diagram & Physical Design (OrCAD Representation)</h2>
        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner mb-10 border border-gray-200">
            <p class="text-lg text-gray-700 mb-4">
                A comprehensive <strong>Electrical Component Levelling Diagram</strong>, designed using software like <strong>OrCAD</strong>, would provide a multi-layered view of the system's physical and electrical architecture. This goes beyond functional blocks to detail actual component placement, wiring, and safety features.
            </p>
            <ul class="list-disc list-inside text-gray-700 space-y-3 mb-4">
                <li>
                    <span class="font-semibold text-blue-700">Level 1: Site Layout & Major Equipment Placement:</span>
                    <div class="ml-4 text-sm mt-1">
                        This layer would show the overall physical footprint of the system within the slum cluster. It would include the designated area for the Anaerobic Digester (WtE plant), the locations of rooftop solar arrays on various buildings, the central Power Management Unit (PMU) enclosure, and the main distribution lines. OrCAD could be used for precise spatial planning and cable routing pathways.
                    </div>
                </li>
                <li>
                    <span class="font-semibold text-blue-700">Level 2: Main Power Flow & Protection Schematics:</span>
                    <div class="ml-4 text-sm mt-1">
                        This level would detail the high-level electrical connections. It would show:
                        <ul class="list-circle list-inside ml-6 mt-1">
                            <li>DC wiring from solar panels to the inverter/charge controller (with string configurations, combiner boxes, and fuses).</li>
                            <li>AC wiring from the biogas generator to the main switchgear.</li>
                            <li>Connections to the battery bank (with DC disconnects and circuit breakers).</li>
                            <li>The main AC busbar within the PMU, showing inputs from solar inverter and biogas generator, and outputs to the micro-grid.</li>
                            <li>Overcurrent protection devices (circuit breakers, fuses) and surge protection devices at key points.</li>
                        </ul>
                        OrCAD's schematic capture tools would be crucial here to represent each component (solar panels, inverters, batteries, generators, circuit breakers, contactors) with its proper symbol and connection.
                    </div>
                </li>
                <li>
                    <span class="font-semibold text-blue-700">Level 3: Control & Monitoring Circuitry (PCB Layouts):</span>
                    <div class="ml-4 text-sm mt-1">
                        This layer would focus on the internal workings of the Power Management Unit (PMU) and smart meters. OrCAD's PCB design capabilities would be used to:
                        <ul class="list-circle list-inside ml-6 mt-1">
                            <li>Design the control board for the PMU, including microcontrollers, sensor interfaces (for voltage, current, temperature), communication modules (e.g., Wi-Fi, LoRa for remote monitoring).</li>
                            <li>Detail the wiring for relays, contactors, and protection circuits that manage power flow between sources, storage, and loads.</li>
                            <li>Show the layout of components on the Printed Circuit Boards (PCBs) for efficient and compact design.</li>
                        </ul>
                    </div>
                </li>
                <li>
                    <span class="font-semibold text-blue-700">Level 4: Micro-Grid Distribution Network:</span>
                    <div class="ml-4 text-sm mt-1">
                        This level would map out the low-voltage distribution network within the slum. It would illustrate:
                        <ul class="list-circle list-inside ml-6 mt-1">
                            <li>The feeder lines branching out from the PMU.</li>
                            <li>Locations of distribution boxes and individual household connection points.</li>
                            <li>Integration of smart meters at each household for monitoring and billing.</li>
                            <li>Street lighting connections.</li>
                        </ul>
                        While OrCAD might focus on the electrical aspects, this layer would also integrate with geographical information system (GIS) data for optimal physical routing.
                    </div>
                </li>
            </ul>
            <p class="text-center text-gray-500 text-xs mt-4">
                *(This detailed multi-level representation ensures comprehensive planning for installation, maintenance, and safety, as would be generated by OrCAD.)*
            </p>
        </div>

        <!-- Simulation Data Section -->
        <h2 class="text-2xl sm:text-3xl font-bold text-center text-blue-700 mb-6">Simulation Data & Performance Metrics (Daily)</h2>
        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner mb-10 border border-gray-200">
            <p class="text-lg text-gray-700 mb-4">
                The data below represents the output from our <strong>HOMER Pro simulation</strong>, which performs complex calculations step-by-step:
            </p>
            <ul class="list-disc list-inside text-gray-700 space-y-2 mb-4">
                <li>
                    <span class="font-semibold">Step 1: Resource Assessment</span> - HOMER Pro analyzes hourly solar irradiance data and daily waste availability to determine potential energy input.
                </li>
                <li>
                    <span class="font-semibold">Step 2: Load Profile Definition</span> - It models the community's electricity demand based on hourly consumption patterns for households and businesses.
                </li>
                <li>
                    <span class="font-semibold">Step 3: Component Sizing & Dispatch</span> - The software simulates various combinations of WtE plant capacity, solar PV array size, and battery storage, dispatching power to meet demand while optimizing for cost and performance.
                </li>
                <li>
                    <span class="font-semibold">Step 4: Economic & Environmental Analysis</span> - It calculates key metrics like Levelized Cost of Energy (LCOE), net present cost, and greenhouse gas emissions reduction.
                </li>
            </ul>
            <p class="text-lg text-gray-700 mb-4">
                The results presented in the cards below are derived from this detailed simulation process.
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div id="wteEnergyCard" class="p-5 rounded-2xl shadow-md bg-green-100 border-green-400 flex flex-col justify-between">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Energy from Waste-to-Energy</h3>
                <p class="text-3xl font-extrabold text-blue-900 mb-3" id="wteEnergyValue">0.00 kWh</p>
                <p class="text-sm text-gray-700">Electricity generated from processing organic waste.</p>
            </div>
            <div id="solarEnergyCard" class="p-5 rounded-2xl shadow-md bg-yellow-100 border-yellow-400 flex flex-col justify-between">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Energy from Solar PV</h3>
                <p class="text-3xl font-extrabold text-blue-900 mb-3" id="solarEnergyValue">0.00 kWh</p>
                <p class="text-sm text-gray-700">Electricity generated from rooftop solar panels.</p>
            </div>
            <div id="totalEnergyCard" class="p-5 rounded-2xl shadow-md bg-blue-100 border-blue-400 flex flex-col justify-between">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Total Energy Generated</h3>
                <p class="text-3xl font-extrabold text-blue-900 mb-3" id="totalEnergyValue">0.00 kWh</p>
                <p class="text-sm text-gray-700">Combined daily electricity output from both sources.</p>
            </div>
            <div id="estimatedDemandCard" class="p-5 rounded-2xl shadow-md bg-purple-100 border-purple-400 flex flex-col justify-between">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Estimated Community Demand</h3>
                <p class="text-3xl font-extrabold text-blue-900 mb-3" id="estimatedDemandValue">0.00 kWh</p>
                <p class="text-sm text-gray-700">Approximate daily electricity need for all households.</p>
            </div>
        </div>

        <!-- Visual Data Representation (Graphs) -->
        <h2 class="text-2xl sm:text-3xl font-bold text-center text-blue-700 mb-6">Visual Data Representation (Daily Energy Balance)</h2>
        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner mb-10 border border-gray-200 flex justify-center">
            <canvas id="energyBarChart" width="600" height="400"></canvas>
        </div>

        <!-- Gemini API Insights Section -->
        <h2 class="text-2xl sm:text-3xl font-bold text-center text-blue-700 mb-6">Generate Insights with Gemini</h2>
        <div class="bg-gray-50 p-6 rounded-2xl shadow-inner mb-10 border border-gray-200">
            <label for="geminiPrompt" class="text-lg font-semibold text-gray-700 mb-2">
                Ask a question about the simulation results:
            </label>
            <textarea id="geminiPrompt" rows="4" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200" placeholder="e.g., 'Explain the environmental impact of these inputs.'"></textarea>
            <button id="getInsightBtn" class="mt-4 w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-blue-700 transition duration-300">
                Get Insight
            </button>
            <div id="geminiResponseContainer" class="mt-6 p-4 bg-white rounded-xl shadow-md border border-gray-300 min-h-[100px]">
                <p class="text-gray-500 text-center" id="geminiResponse">Your insights from the Gemini API will appear here.</p>
            </div>
        </div>
        
        <!-- Important Findings Section -->
        <h2 class="text-2xl sm:text-3xl font-bold text-center text-blue-700 mb-6">Important Findings & Viability Confirmation</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div id="wasteDivertedCard" class="p-5 rounded-2xl shadow-md bg-teal-100 border-teal-400 flex flex-col justify-between">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Waste Diverted from Landfill</h3>
                <p class="text-3xl font-extrabold text-blue-900 mb-3" id="wasteDivertedValue">0.00 kg</p>
                <p class="text-sm text-gray-700">Organic waste processed by the system, significantly reducing landfill burden and pollution.</p>
            </div>
            <div id="methaneReducedCard" class="p-5 rounded-2xl shadow-md bg-red-100 border-red-400 flex flex-col justify-between">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Methane Emissions Reduced</h3>
                <p class="text-3xl font-extrabold text-blue-900 mb-3" id="methaneReducedValue">0.00 kg</p>
                <p class="text-sm text-gray-700">Equivalent methane emissions avoided, contributing to climate change mitigation.</p>
            </div>
            <div id="unmetDemandCard" class="p-5 rounded-2xl shadow-md bg-green-200 border-green-500 flex flex-col justify-between">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Unmet Demand</h3>
                <p class="text-3xl font-extrabold text-blue-900 mb-3" id="unmetDemandValue">0.00 kWh</p>
                <p class="text-sm text-gray-700">Electricity demand not met by the hybrid system. Aim for 0 for full sufficiency!</p>
            </div>
            <div id="systemSufficiencyCard" class="p-5 rounded-2xl shadow-md bg-green-200 border-green-500 flex flex-col justify-between">
                <h3 class="text-xl font-bold text-gray-800 mb-2">System Sufficiency</h3>
                <p class="text-3xl font-extrabold text-blue-900 mb-3" id="systemSufficiencyValue">Sufficient</p>
                <p class="text-sm text-gray-700" id="systemSufficiencyDescription">The system can meet or exceed daily demand based on current parameters.</p>
            </div>
        </div>

        <div class="mt-10 text-center text-gray-600 text-sm">
            <p>
                *Simulation parameters are based on typical averages and can be adjusted for specific regional data.
                This model confirms the viability of the Urban Synergy Hub through data-driven analysis.
            </p>
        </div>
    </div>

    <script>
        const dailyWasteKgInput = document.getElementById('dailyWasteKg');
        const rooftopAreaSqMInput = document.getElementById('rooftopAreaSqM');
        const numHouseholdsInput = document.getElementById('numHouseholds');

        const wteEnergyValue = document.getElementById('wteEnergyValue');
        const solarEnergyValue = document.getElementById('solarEnergyValue');
        const totalEnergyValue = document.getElementById('totalEnergyValue');
        const estimatedDemandValue = document.getElementById('estimatedDemandValue');
        const wasteDivertedValue = document.getElementById('wasteDivertedValue');
        const methaneReducedValue = document.getElementById('methaneReducedValue');
        const unmetDemandValue = document.getElementById('unmetDemandValue');
        const systemSufficiencyValue = document.getElementById('systemSufficiencyValue');
        const systemSufficiencyDescription = document.getElementById('systemSufficiencyDescription');

        const unmetDemandCard = document.getElementById('unmetDemandCard');
        const systemSufficiencyCard = document.getElementById('systemSufficiencyCard');

        const energyBarChartCanvas = document.getElementById('energyBarChart');
        const ctx = energyBarChartCanvas.getContext('2d');

        const ORGANIC_WASTE_PERCENTAGE = 0.6;
        const BIOGAS_YIELD_PER_TON = 55;
        const ELECTRICITY_PER_CUBIC_METER_BIOGAS = 2;
        const SOLAR_INSOLATION_HOURS = 4.5;
        const SOLAR_PANEL_EFFICIENCY = 0.20;
        const AVG_HOUSEHOLD_DEMAND_KWH_DAY = 7;
        const METHANE_EMISSION_FACTOR_KG_PER_TON_WASTE = 100;

        function calculateSimulation() {
            const dailyWasteKg = parseFloat(dailyWasteKgInput.value);
            const rooftopAreaSqM = parseFloat(rooftopAreaSqMInput.value);
            const numHouseholds = parseFloat(numHouseholdsInput.value);

            const organicWasteTons = (dailyWasteKg * ORGANIC_WASTE_PERCENTAGE) / 1000;
            const biogasProducedCubicM = organicWasteTons * BIOGAS_YIELD_PER_TON;
            const wteEnergy = biogasProducedCubicM * ELECTRICITY_PER_CUBIC_METER_BIOGAS;

            const solarEnergy = rooftopAreaSqM * SOLAR_PANEL_EFFICIENCY * SOLAR_INSOLATION_HOURS * 1;

            const totalGenerated = wteEnergy + solarEnergy;

            const demand = numHouseholds * AVG_HOUSEHOLD_DEMAND_KWH_DAY;

            const unmet = Math.max(0, demand - totalGenerated);

            const wasteDiverted = dailyWasteKg * ORGANIC_WASTE_PERCENTAGE;

            const methaneReduced = organicWasteTons * METHANE_EMISSION_FACTOR_KG_PER_TON_WASTE;

            wteEnergyValue.textContent = `${wteEnergy.toFixed(2)} kWh`;
            solarEnergyValue.textContent = `${solarEnergy.toFixed(2)} kWh`;
            totalEnergyValue.textContent = `${totalGenerated.toFixed(2)} kWh`;
            estimatedDemandValue.textContent = `${demand.toFixed(2)} kWh`;
            wasteDivertedValue.textContent = `${wasteDiverted.toFixed(2)} kg`;
            methaneReducedValue.textContent = `${methaneReduced.toFixed(2)} kg`;
            unmetDemandValue.textContent = `${unmet.toFixed(2)} kWh`;

            if (unmet > 0) {
                unmetDemandCard.classList.remove('bg-green-200', 'border-green-500');
                unmetDemandCard.classList.add('bg-red-200', 'border-red-500');
            } else {
                unmetDemandCard.classList.remove('bg-red-200', 'border-red-500');
                unmetDemandCard.classList.add('bg-green-200', 'border-green-500');
            }

            if (totalGenerated >= demand) {
                systemSufficiencyValue.textContent = "Sufficient";
                systemSufficiencyDescription.textContent = "The system can meet or exceed daily demand based on current parameters.";
                systemSufficiencyCard.classList.remove('bg-red-200', 'border-red-500');
                systemSufficiencyCard.classList.add('bg-green-200', 'border-green-500');
            } else {
                systemSufficiencyValue.textContent = "Insufficient";
                systemSufficiencyDescription.textContent = "The system cannot fully meet daily demand. Consider increasing waste input, solar area, or optimizing demand.";
                systemSufficiencyCard.classList.remove('bg-green-200', 'border-green-500');
                systemSufficiencyCard.classList.add('bg-red-200', 'border-red-500');
            }

            drawEnergyBarChart(wteEnergy, solarEnergy, totalGenerated, demand);
        }

        function drawEnergyBarChart(wteEnergy, solarEnergy, totalEnergy, estimatedDemand) {
            const width = energyBarChartCanvas.width;
            const height = energyBarChartCanvas.height;
            ctx.clearRect(0, 0, width, height);

            const data = [
                { label: 'WtE Energy', value: wteEnergy, color: '#4CAF50' },
                { label: 'Solar Energy', value: solarEnergy, color: '#FFC107' },
                { label: 'Total Generated', value: totalEnergy, color: '#2196F3' },
                { label: 'Estimated Demand', value: estimatedDemand, color: '#9C27B0' },
            ];

            const maxValue = Math.max(...data.map(item => item.value)) * 1.1;
            const barWidth = (width - 100) / data.length;
            const startX = 50;
            const startY = height - 50;

            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(startX, 20);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(width - 20, startY);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.stroke();

            const numYLabels = 5;
            for (let i = 0; i <= numYLabels; i++) {
                const yValue = (maxValue / numYLabels) * i;
                const yPos = startY - (yValue / maxValue) * (startY - 20);
                ctx.fillStyle = '#555';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(yValue.toFixed(0) + ' kWh', startX - 5, yPos + 4);

                if (i > 0) {
                    ctx.beginPath();
                    ctx.moveTo(startX, yPos);
                    ctx.lineTo(width - 20, yPos);
                    ctx.strokeStyle = '#eee';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            }

            data.forEach((item, index) => {
                const barHeight = (item.value / maxValue) * (startY - 20);
                const xPos = startX + index * barWidth + (barWidth / 4);
                const yPos = startY - barHeight;

                ctx.fillStyle = item.color;
                ctx.fillRect(xPos, yPos, barWidth / 2, barHeight);

                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(item.value.toFixed(0), xPos + barWidth / 4, yPos - 5);

                ctx.fillStyle = '#333';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(item.label, xPos + barWidth / 4, startY + 20);
            });
        }
        
        async function getGeminiInsight() {
            const promptInput = document.getElementById('geminiPrompt');
            const responseContainer = document.getElementById('geminiResponse');
            const getInsightBtn = document.getElementById('getInsightBtn');
            
            getInsightBtn.disabled = true;
            getInsightBtn.textContent = "Generating...";
            responseContainer.innerHTML = '<p class="text-center text-gray-500">Loading...</p>';

            const dailyWasteKg = parseFloat(document.getElementById('dailyWasteKg').value);
            const rooftopAreaSqM = parseFloat(document.getElementById('rooftopAreaSqM').value);
            const numHouseholds = parseFloat(document.getElementById('numHouseholds').value);
            
            const ORGANIC_WASTE_PERCENTAGE = 0.6;
            const BIOGAS_YIELD_PER_TON = 55;
            const ELECTRICITY_PER_CUBIC_METER_BIOGAS = 2;
            const SOLAR_PANEL_EFFICIENCY = 0.20;
            const SOLAR_INSOLATION_HOURS = 4.5;
            const AVG_HOUSEHOLD_DEMAND_KWH_DAY = 7;
            const METHANE_EMISSION_FACTOR_KG_PER_TON_WASTE = 100;
            
            const organicWasteTons = (dailyWasteKg * ORGANIC_WASTE_PERCENTAGE) / 1000;
            const wteEnergy = organicWasteTons * BIOGAS_YIELD_PER_TON * ELECTRICITY_PER_CUBIC_METER_BIOGAS;
            const solarEnergy = rooftopAreaSqM * SOLAR_PANEL_EFFICIENCY * SOLAR_INSOLATION_HOURS;
            const totalGenerated = wteEnergy + solarEnergy;
            const demand = numHouseholds * AVG_HOUSEHOLD_DEMAND_KWH_DAY;
            const unmet = Math.max(0, demand - totalGenerated);
            const wasteDiverted = dailyWasteKg * ORGANIC_WASTE_PERCENTAGE;
            const methaneReduced = organicWasteTons * METHANE_EMISSION_FACTOR_KG_PER_TON_WASTE;

            const userPrompt = promptInput.value;
            
            const fullPrompt = `You are a helpful AI assistant for an Urban Synergy Hub simulator. The current simulation parameters are:
            - Daily Waste: ${dailyWasteKg} kg
            - Rooftop Area: ${rooftopAreaSqM} sq M
            - Number of Households: ${numHouseholds}
            
            The simulation results are:
            - Energy from Waste-to-Energy: ${wteEnergy.toFixed(2)} kWh
            - Energy from Solar PV: ${solarEnergy.toFixed(2)} kWh
            - Total Energy Generated: ${totalGenerated.toFixed(2)} kWh
            - Estimated Community Demand: ${demand.toFixed(2)} kWh
            - Unmet Demand: ${unmet.toFixed(2)} kWh
            - Waste Diverted: ${wasteDiverted.toFixed(2)} kg
            - Methane Emissions Reduced: ${methaneReduced.toFixed(2)} kg
            
            Based on this data, please provide a concise and clear answer to the following question:
            '${userPrompt}'`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: fullPrompt }] });
            const payload = { contents: chatHistory };

            let retries = 3;
            let delay = 1000;
            
            while(retries > 0){
                try {
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                            retries--;
                            continue;
                        } else {
                            throw new Error(`API call failed with status: ${response.status}`);
                        }
                    }
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        responseContainer.innerHTML = `<p>${text}</p>`;
                    } else {
                        responseContainer.innerHTML = '<p class="text-red-500">Could not retrieve a valid response from the API.</p>';
                    }
                    break;
                } catch (error) {
                    console.error('Error fetching from Gemini API:', error);
                    responseContainer.innerHTML = `<p class="text-red-500">An error occurred: ${error.message}</p>`;
                    break;
                }
            }
            
            getInsightBtn.disabled = false;
            getInsightBtn.textContent = "Get Insight";
        }
        
        dailyWasteKgInput.addEventListener('input', calculateSimulation);
        rooftopAreaSqMInput.addEventListener('input', calculateSimulation);
        numHouseholdsInput.addEventListener('input', calculateSimulation);
        document.getElementById('getInsightBtn').addEventListener('click', getGeminiInsight);

        window.onload = calculateSimulation;
    </script>
</body>
</html>
